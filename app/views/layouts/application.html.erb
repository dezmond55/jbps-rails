<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "JBPS - James Building & Property Services" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Outfit:wght@300;400;500;600;700;800;900&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <div class="grain"></div>
    <nav class="nav" id="nav">
      <a href="<%= root_path %>" class="nav-logo">
        <div>
          <div class="nav-wordmark">JAMES</div>
          <div class="nav-descriptor">Building &amp; Property Services</div>
        </div>
      </a>
      <div class="nav-links">
        <a href="<%= root_path %>#services" class="nav-link">Services</a>
        <a href="<%= about_path %>" class="nav-link">About</a>
        <a href="<%= root_path %>#regions" class="nav-link">Regions</a>
        <a href="<%= root_path %>#quote" class="nav-link">Contact</a>
        <a href="<%= root_path %>#quote" class="nav-cta">Contact Us</a>
      </div>
    </nav>

    <%= yield %>

    <footer class="footer">
      <div class="footer-main">
        <div>
          <div class="footer-brand-mark">JAMES</div>
          <div class="footer-brand-desc">Commercial construction, facilities management, and property services across South Australia and Victoria. From the Limestone Coast to Adelaide and Western Victoria.</div>
        </div>
        <div class="footer-col">
          <h4>Services</h4>
          <a href="/#services">Commercial Construction</a>
          <a href="/#services">Facilities Management</a>
          <a href="/#services">Renovations &amp; Upgrades</a>
          <a href="/#quote">Contact Us</a>
        </div>
        <div class="footer-col">
          <h4>Company</h4>
          <%= link_to "About JBPS", about_path %>
          <a href="/#regions">Service Regions</a>
          <a href="/#quote">Contact</a>
        </div>
        <div class="footer-col">
          <h4>Contact</h4>
          <p>
            <a href="tel:0887621455">(08) 8762 1455</a><br>
            <a href="mailto:admin@jbps.com.au">admin@jbps.com.au</a><br><br>
            88 Gordon Street<br>
            Naracoorte SA 5271
          </p>
        </div>
      </div>
      <div class="footer-bar">
        <div class="footer-legal">&copy; <%= Time.current.year %> James Building &amp; Property Services Pty Ltd. All rights reserved.</div>
        <div class="footer-badges">SA BLD 252235 &nbsp;&middot;&nbsp; VIC CB-U 65290</div>
      </div>
    </footer>

  <script>
    (function () {
      /* === NAV SCROLL (set up once) === */
      var nav = document.getElementById('nav');
      if (nav) {
        window.addEventListener('scroll', function () {
          nav.classList.toggle('scrolled', window.scrollY > 80);
        }, { passive: true });
      }

      /* === SERVICE STRIP ACCORDION (event delegation — Turbo-safe) === */
      document.addEventListener('click', function (e) {
        var header = e.target.closest('.service-strip-header');
        if (!header) return;
        var strip = header.closest('.service-strip');
        if (!strip) return;
        var wasActive = strip.classList.contains('active');
        document.querySelectorAll('.service-strip').forEach(function (s) { s.classList.remove('active'); });
        if (!wasActive) strip.classList.add('active');
      });

      /* === SMOOTH SCROLL (event delegation — Turbo-safe) === */
      document.addEventListener('click', function (e) {
        var link = e.target.closest('a[href^="#"]');
        if (!link) return;
        var target = document.querySelector(link.getAttribute('href'));
        if (target) {
          e.preventDefault();
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      });

      /* === FORM SUCCESS (redirect-based) === */
      function checkFormSuccess() {
        if (new URLSearchParams(window.location.search).get('sent') !== '1') return;
        var fields = document.getElementById('formFields');
        var successEl = document.getElementById('formSuccess');
        if (fields) fields.style.display = 'none';
        if (successEl) successEl.classList.add('show');
        history.replaceState(null, '', window.location.pathname + '#quote');
      }
      checkFormSuccess();
      document.addEventListener('turbo:load', checkFormSuccess);

      /* === BOOT — runs on initial load AND after each Turbo navigation === */
      var revealObserver, counterObserver;

      function boot() {
        /* Scroll reveal */
        if (revealObserver) revealObserver.disconnect();
        revealObserver = new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (entry.isIntersecting) entry.target.classList.add('vis');
          });
        }, { threshold: 0.08, rootMargin: '0px 0px -60px 0px' });
        document.querySelectorAll('.reveal').forEach(function (el) {
          revealObserver.observe(el);
        });

        /* Animated counter */
        if (counterObserver) counterObserver.disconnect();
        counterObserver = new IntersectionObserver(function (entries) {
          entries.forEach(function (entry) {
            if (!entry.isIntersecting) return;
            var el = entry.target;
            var target = parseInt(el.dataset.count, 10);
            var suffix = el.dataset.suffix || '';
            if (!target) return;
            var current = 0;
            var step = Math.ceil(target / 40);
            var timer = setInterval(function () {
              current += step;
              if (current >= target) { current = target; clearInterval(timer); }
              el.textContent = current + suffix;
            }, 30);
            counterObserver.unobserve(el);
          });
        }, { threshold: 0.5 });
        document.querySelectorAll('[data-count]').forEach(function (el) {
          counterObserver.observe(el);
        });
      }

      boot();
      document.addEventListener('turbo:load', boot);
    })();
  </script>
  </body>
</html>
